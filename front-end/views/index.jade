doctype html
html
  head
    title= 'ETA Map'
    link(rel='stylesheet', href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css')
    link(href='https://www.mapbox.com/base/latest/base.css', rel='stylesheet')
    script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js")
    script(src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js')
    style.
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1 }
        #go-button { position: absolute; top: 10px; left: 330px; width: 50px; height: 80px; z-index: 2 }
  body
    script(src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js')
    link(rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css')
    script(src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v3.1.3/mapbox-gl-directions.js')
    link(rel='stylesheet', href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v3.1.3/mapbox-gl-directions.css', type='text/css')
    div(id='map')
    button(class="button", id="go-button").
        Go
    script.
        function _fillData(layer, data) {
            var gpspoints = data.split("\n");
            i = 0;
            gpspoints.forEach(function(element) {
                gpspoints[i] = element.split(" ");
                if (gpspoints[i][0] && gpspoints[i][1]) {
                    layer.source.data.geometry.coordinates.push([parseFloat(gpspoints[i][0]), parseFloat(gpspoints[i][1])]);
                }
                i++;
            });
            return layer;
        }
        function _drawLines(map, id, color, data) {
            var layer = {
                "id": id,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "type": "LineString",
                            "coordinates": []
                        }
                    }
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": color,
                    "line-width": 8
                }
            };
            map.addLayer(_fillData(layer, data));
        };

        function _drawPoints(map, id, color, data) {
            var layer = {
                "id": id,
                "type": "circle",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "type": "LineString",
                            "coordinates": []
                        }
                    }
                },
                "layout": {
                },
                "paint": {
                    "circle-color": color,
                    "circle-radius": 8
                }
            };
            map.addLayer(_fillData(layer, data));
        };

        mapboxgl.accessToken = 'pk.eyJ1IjoiaHc5NjAzIiwiYSI6ImNqajJwaHUzZTBucTUzdnRiMGN4NWE5Z2kifQ.BV0MuwZu5dkZBm1EOR5eGg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-guidance-day-v2',
            center: [104.0647, 30.6109],
            zoom: 10
        });

        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'bottom-right');

        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }), 'bottom-right');

        var mapDirections = new MapboxDirections({accessToken: mapboxgl.accessToken})
        map.addControl(mapDirections, 'top-left');

        // var geocoderStart = new MapboxGeocoder({
        //     accessToken: mapboxgl.accessToken,
        //     placeholder: "Choose starting point..."
        // });
        // var geocoderEnd = new MapboxGeocoder({
        //     accessToken: mapboxgl.accessToken,
        //     placeholder: "Choose destination..."
        // });

        // map.addControl(geocoderStart, 'top-left');
        // map.addControl(geocoderEnd, 'top-left');

        // var markerStart;
        // var markerEnd;
        var srclat;
        var srclon;
        var dstlat;
        var dstlon;

        map.on('load', function() {
            mapDirections.on('route', function(){
                // mapDirections.removeRoutes();
            });
            mapDirections.on('origin', function(){
                srclat = mapDirections.getOrigin().geometry.coordinates[1];
                srclon = mapDirections.getOrigin().geometry.coordinates[0];
            });
            mapDirections.on('destination', function(){
                dstlat = mapDirections.getDestination().geometry.coordinates[1];
                dstlon = mapDirections.getDestination().geometry.coordinates[0];
            });
        //     geocoderStart.on('result', function(ev) {
        //         if (typeof markerStart !== "undefined") {
        //             markerStart.remove();
        //         }
        //         markerStart = new mapboxgl.Marker()
        //             .setLngLat(ev.result.geometry.coordinates)
        //             .addTo(map);
        //         srclat = ev.result.geometry.coordinates[1];
        //         srclon = ev.result.geometry.coordinates[0];
        //     });
        //     geocoderEnd.on('result', function(ev) {
        //         if (typeof markerEnd !== "undefined") {
        //             markerEnd.remove();
        //         }
        //         markerEnd = new mapboxgl.Marker()
        //             .setLngLat(ev.result.geometry.coordinates)
        //             .addTo(map);
        //         dstlat = ev.result.geometry.coordinates[1];
        //         dstlon = ev.result.geometry.coordinates[0];
        //     });

        });

        $(document).ready(function(){
            $("button").click(function(){
                $.post("/upload",
                {
                  srclat: srclat,
                  srclon: srclon,
                  dstlat: dstlat,
                  dstlon: dstlon
                },
                function(data, status){
                    _drawLines(map, "route", "#C05C58", data);
                    _drawPoints(map, "original_point", "#303CA8", data);
                });

                $.post("/getfakedata",
                {
                },
                function(data, status){
                    _drawPoints(map, "point", "#307C38", data);
                });
            });
        });








